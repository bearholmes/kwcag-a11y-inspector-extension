# Security Review

## 요약

이 문서는 콘텐츠 스크립트 기반 인스펙터에서 확인된 교차 사이트 스크립팅(XSS) 위험을 다룹니다. 인스펙터가 검사 대상 페이지의 CSS 값을 읽어 오버레이에 표시할 때 HTML 이스케이프가 적용되지 않아, 악의적인 페이지가 임의의 마크업을 삽입할 수 있습니다. 아래 섹션에서 취약 지점, 재현 가능성, 대응 방안을 정리합니다.

## 위험 시나리오

1. 사용자가 악성 페이지에서 확장 프로그램 인스펙터를 실행합니다.
2. 악성 페이지는 `style` 속성에 스크립트가 실행되는 값(예: `<img src=x onerror=alert(1)>`)을 포함시킵니다.
3. 인스펙터가 CSS 값을 읽어 오버레이에 `innerHTML`로 삽입하면 브라우저가 이를 HTML로 파싱하여 코드가 실행됩니다.
4. 공격자는 페이지 컨텍스트에서 코드를 실행해 사용자 데이터 탈취, 추가 스크립트 주입 등으로 악용할 수 있습니다.

## 발견 사항

### 1. 페이지 제어 CSS 값의 무단 HTML 렌더링

- **위치:** `src/content/inspector/css-handlers.ts` (`setCSSPropertyIf`, `setCSSPropertyValue`, `setCSSPropertyValueIf`)
- **문제:** 위 함수들이 페이지에서 읽어 온 CSS 속성 값을 그대로 `innerHTML`에 대입합니다. 값에 `<img>`/`<svg>` 또는 `url("x" onerror="...")` 등 HTML/JS 페이로드가 포함되면 오버레이가 이를 그대로 파싱하여 실행합니다.
- **영향:** 사용자가 악성 페이지에서 인스펙터를 실행할 때 페이지 컨텍스트에서 코드가 실행되는 XSS가 발생할 수 있습니다. 이는 확장 프로그램 UI 격리를 무력화하고 사용자 신뢰를 깨뜨립니다.
- **권고:** 페이지에서 오는 값은 신뢰할 수 없으므로 `textContent`(또는 텍스트 노드 생성)로 렌더링하거나 공통 이스케이프 헬퍼를 도입해 `innerHTML` 사용을 제거하십시오. 오버레이 UI 전반에 같은 원칙을 적용해 유사한 취약점 회귀를 막습니다.

### 2. 잠재적 회귀를 유발하는 위험한 헬퍼 (해결)

- **위치:** `src/shared/dom-utils.ts` (`setInnerHTML`)
- **문제:** `setInnerHTML`은 경고만 남긴 채 `element.innerHTML = html`을 감싸고 있습니다. 현재 사용되지 않더라도 유지되는 한 향후 코드가 이를 호출해 동일한 XSS 벡터를 도입할 위험이 있습니다.
- **조치:** 위험 헬퍼를 완전히 제거하고 텍스트 전용 `setTextContent`/`createElement` 조합만 노출하도록 정리했습니다. HTML 문자열을 직접 삽입하는 경로를 없애 잠재적 회귀 가능성을 제거했습니다.
- **영향:** 향후 기능 추가나 리팩터링 시 실수로 불안전한 HTML 삽입이 재도입될 수 있습니다.
- **권고:** 헬퍼를 제거하거나 안전한 대체 함수(텍스트 전용 렌더러)로 교체하고, 불가피하게 유지해야 한다면 주석과 타입을 통해 명확히 위험성을 표시해 사용을 차단하십시오.

## 대응 우선순위

1. **단기(즉시 수정):** 오버레이 렌더링 경로에서 `innerHTML` 사용을 제거하고 텍스트 렌더링으로 교체합니다. 동시에 `setInnerHTML` 헬퍼를 제거하거나 안전 대체제에 의존하도록 코드 베이스를 정리합니다.
2. **중기(방어 보강):** 위험 문자열을 탐지하는 ESLint/유닛 테스트 규칙을 추가해 `innerHTML` 직접 사용을 금지합니다. 신규 UI 코드에도 동일한 규칙을 적용합니다.
3. **장기(거버넌스):** 보안 코드 리뷰 체크리스트에 "페이지 입력을 UI에 삽입할 때 반드시 이스케이프/텍스트 렌더링" 항목을 추가하고, 빌드 단계에서 정적 분석을 통해 회귀를 차단합니다.
